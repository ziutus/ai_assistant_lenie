AWSTemplateFormatVersion: '2010-09-09'
Description: 'Lambda Layer with OpenAI SDK for Project Lenie'

Parameters:
  ProjectCode:
    Type: String
    Default: lenie
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      # Post-MVP: add prod, qa as needed
    Description: Environment name
  LayerCodeBucket:
    Type: String
    Description: S3 bucket containing the layer code ZIP artifact
  LayerCodeS3Key:
    Type: String
    Default: layers/lenie_openai.zip
    Description: S3 key for the layer code ZIP artifact
  LayerCodeVersion:
    Type: String
    Default: '1'
    Description: Version identifier — change this to force a new layer version when S3 key stays the same

Conditions:
  IsProduction: !Or
    - !Equals [!Ref Environment, prod]
    - !Equals [!Ref Environment, qa]
    - !Equals [!Ref Environment, qa2]
    - !Equals [!Ref Environment, qa3]

Resources:
  # Lambda Layer — stateless resource, recreated on every deploy (no DeletionPolicy needed)
  LenieOpenaiLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      LayerName: lenie_openai
      Description: !Sub 'Lambda Layer with OpenAI SDK for Project Lenie (v${LayerCodeVersion})'
      CompatibleRuntimes:
        - python3.11
      Content:
        S3Bucket: !Ref LayerCodeBucket
        S3Key: !Ref LayerCodeS3Key

  # SSM Parameter exports — layer ARN includes version number for consuming Lambda functions
  LenieOpenaiLayerArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub '/${ProjectCode}/${Environment}/lambda/layers/openai/arn'
      Type: String
      Value: !Ref LenieOpenaiLayer
      Description: 'Lambda Layer ARN (with version) for openai layer for Project Lenie'
      Tags:
        Environment: !Ref Environment
        Project: !Ref ProjectCode
