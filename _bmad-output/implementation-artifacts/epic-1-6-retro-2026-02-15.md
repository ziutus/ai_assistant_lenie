# Sprint 1 Retrospective — Epics 1-6: IaC Coverage & Cleanup

**Date:** 2026-02-15
**Facilitator:** Bob (Scrum Master)
**Participants:** Ziutus (Project Lead), Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev)
**Agent Model:** Claude Opus 4.6

## Epic Summary

| Epic | Title | Stories | Status |
|------|-------|---------|--------|
| 1 | Storage Layer IaC Coverage | 3 | Done |
| 2 | Compute Layer IaC Coverage | 1 | Done |
| 3 | S3 Content Migration | 1 | Done |
| 4 | Application Delivery IaC Coverage | 2 | Done |
| 5 | AWS Account Cleanup & Code Hygiene | 2 | Done |
| 6 | Deployment Orchestration & Documentation | 1 | Done |

**Total:** 6 epics, 10 stories — 100% completion

## Delivery Metrics

- Stories completed: 10/10 (100%)
- New CloudFormation templates: 9
- New parameter files: 9
- Modified files: ~15
- Deleted files: 3 (ses.yaml, api-gw-url-lenie.json, RUM code)
- Legacy AWS resources removed: 9
- Production incidents: 0
- Code review pass rate: 10/10

## What Went Well

### 1. Two-Phase CF Import Pattern
Developed in Story 1.1, this became the golden pattern for all CF imports (Stories 1.3, 4.1, 4.2). Phase 1 imports primary resource only; Phase 2 adds SSM Parameters, Tags, and Policies. This pattern was necessary because SSM Parameters cannot be included in import change sets.

### 2. Gen 2+ Canonical Template Pattern
The canonical template structure (Parameters → Conditions → Resources → SSM Parameter exports) was established and consistently evolved. Each story's code review fed improvements back into subsequent stories (e.g., IsProduction condition with qa2/qa3, SSM Parameter tags, explanatory comments).

### 3. Iterative Quality Improvement
Code review fixes from Story 1.1 (6 items: SSM tags, IsProduction pattern, flow-style AllowedValues, descriptions) were pre-applied in all subsequent stories, preventing repeated feedback.

### 4. Zero-Downtime S3 Migration
Story 3.1 migrated 3612 objects (728 MB) from lenie-s3-tmp to lenie-dev-website-content with zero downtime. End-to-end verification confirmed Chrome extension → Lambda → S3 flow working correctly.

### 5. Comprehensive Legacy Cleanup
9 legacy resources removed in strict dependency order across 3 phases. Codebase-wide search confirmed no stale references in active code.

### 6. Complete deploy.ini Restructuring
Story 6.1 transformed deploy.ini from a disorganized, fully-commented list to a layer-ordered, uncommented configuration with 8 deployment layers covering 32 active templates.

## Challenges and Learnings

### 1. Windows/MSYS Path Conversion
`MSYS_NO_PATHCONV=1` required for all AWS CLI commands with `/` paths. Discovered in Story 2.1, applied throughout.

### 2. API Gateway Complexity (Story 4.2)
The most complex story — live API had 23 endpoints (vs 11 documented), included Step Functions integration, and template exceeded 51200 byte inline limit requiring S3 upload. Two rounds of code review needed.

### 3. CF Import Gotchas
- Existing bucket policies conflict with CF-managed policies during Phase 2 (Story 1.3)
- KMS encryption mismatch between live and template causes drift requiring manual resolution (Story 1.1)
- CloudFront drift detection has known limitations with tags (Story 4.1)

### 4. AWS CLI v2 Differences
`--cli-binary-format raw-in-base64-out` required for JSON payloads in Lambda invoke (Story 3.1).

### 5. SSM Parameter Verification
`ssm get-parameter` may fail even when parameters exist; `describe-parameters` is more reliable for verification (Story 1.2).

## Technical Debt

| # | Item | Source | Priority | Notes |
|---|------|--------|----------|-------|
| 1 | Lambda Layer dependencies ~1.5 years old | Story 2.1 | High | Security audit and rebuild needed |
| 2 | Lambda name typo `infra-allow-ip-in-secrutity-group` | Story 4.2 | Medium | Requires AWS-side Lambda rename first |
| 3 | CORS wildcard `Access-Control-Allow-Origin: '*'` | Story 4.2 | Medium | Security concern for production |
| 4 | CloudFront origin domain hardcoded | Story 4.1 | Low | Future: consume from SSM Parameter |
| 5 | `lenie-s3-tmp` old bucket not deleted | Story 3.1/5.1 | Low | Data migrated, bucket still exists |
| 6 | `rds.yaml` commented in deploy.ini | Story 6.1 | Low | Managed lifecycle via Step Functions |
| 7 | Frontend manual browser verification not done | Story 5.2 | Low | Requires manual testing |
| 8 | Lambda functions in API GW managed by hardcoded ARN | Story 4.2 | Low | Future: manage as CF resources |

## Key Takeaways

1. **Two-phase CF import is essential** for importing existing AWS resources — SSM Parameters must be added in Phase 2
2. **Code review feedback loops improve quality across stories** — fix-forward pattern prevents recurring issues
3. **Live infrastructure often differs from documentation** — always inspect live state before templating (23 vs 11 API endpoints)
4. **Minimal change approach works** — don't refactor Gen 1 templates when only a reference update is needed
5. **Codebase-wide search after deletions** catches stale references that grep-by-hand would miss

## Next Steps

1. Plan next sprint with new epics (Correct Course or full planning cycle)
2. Address high-priority technical debt (Lambda Layer security audit)
3. Consider future epics for: Lambda CF management, CORS hardening, remaining cleanup items

## Sprint Assessment

**Overall:** Successful sprint with 100% story completion, zero production incidents, and strong pattern establishment. The IaC foundation is now solid for future infrastructure changes.
