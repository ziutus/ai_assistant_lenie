# Epic 15 Retrospective — API Gateway Consolidation

**Date:** 2026-02-21
**Epic:** 15 — API Gateway Consolidation
**Sprint:** 4 — AWS Infrastructure Consolidation & Tooling
**Facilitator:** Bob (Scrum Master)
**Status:** Complete

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories completed | 3/3 (100%) |
| Duration | 1 day (2026-02-20) |
| Agent used | Claude Opus 4.6 (all stories) |
| Blockers encountered | 0 |
| Debug issues (implementation) | 0 |
| Code review issues caught | ~15+ across 3 stories |
| Security issues found | 1 (console.log API key leak — fixed) |
| Technical debt items | 1 (B-3 legacy Lambda rename — deferred) |
| Production incidents | 0 |
| Template size post-consolidation | 29,647 bytes (58% of 51,200 limit) |

## Team Participants

- Bob (Scrum Master) — Facilitator
- Alice (Product Owner) — Business perspective
- Winston (Architect) — Architecture and patterns
- Amelia (Developer) — Implementation
- Quinn (QA Engineer) — Quality and testing
- Ziutus (Project Lead) — Overall direction

## Stories Delivered

### Story 15-1: Merge /url_add Endpoint into api-gw-app.yaml
- Added /url_add POST+OPTIONS to api-gw-app.yaml OpenAPI Body
- Lambda integration URI uses parameterized `!Sub` (hybrid naming approach)
- UrlAddLambdaInvokePermission resource scoped to `/*/*/url_add`
- Template size: 29,647 bytes (58% of limit)
- cfn-lint: zero errors
- Code review: 4 issues fixed (stale counts in 4 doc files)

### Story 15-2: Update Client Applications and Version Releases
- Chrome extension URL updated: `jg40fjwz61` → `1bkc3kz7c9`, version 1.0.22 → 1.0.23
- React app URL already correct (`1bkc3kz7c9` = api-gw-app) — no URL change needed
- React app: CHANGELOG.md created, version 0.1.0 → 0.2.0
- Code Review 1: 7 issues (stale refs in CLAUDE.md, README.md, API_Usage.md, package-lock.json)
- Code Review 2: 4 issues (security: console.log API key leak, fabricated CHANGELOG date, premature claims)

### Story 15-3: Remove Old api-gw-url-add Gateway and Clean Up
- Deleted CF stack `lenie-dev-api-gw-url-add` from AWS
- Deleted template `api-gw-url-add.yaml` and parameter file `api-gw-url-add.json`
- Cleaned deploy.ini — removed commented-out entry
- Updated 5 documentation files
- Code review: 4 issues (API GW count 2→3, template count, missing endpoint in README, stale line ref)

## Successes and Strengths

1. **100% completion rate** — all 3 stories done in 1 day, zero blockers
2. **Well-prepared stories** — detailed AC, Dev Notes, Anti-patterns, and Previous Story Intelligence enabled fast, error-free implementation
3. **Zero debug issues** — no implementation problems in any story
4. **Hybrid naming approach worked** — new /url_add with parameterized `!Sub`, legacy endpoints with hardcoded names — no conflicts
5. **Template size well within limits** — 58% of 51,200 byte limit, large headroom
6. **Early scope reduction** — React app URL already correct, discovered before unnecessary changes
7. **Sequential story design** — merge → update clients → cleanup sequence was logical and effective

## Challenges and Growth Areas

1. **Stale documentation references (systemic)** — all 3 stories had code review issues with outdated references across 15+ files. Root cause: same metrics duplicated in 7+ files
2. **Security issue** — `console.log(apikeyParam)` leaked API key to browser console (Story 15-2). Caught in code review.
3. **Fabricated data** — Agent generated incorrect CHANGELOG date (2025-01-01 instead of 2025-08-28) in Story 15-2
4. **API Gateway count confusion** — PRD said "3 to 2" but actual state is 3 API Gateways (url-add.yaml retains its own). Conceptual difference between removed template (api-gw-url-add.yaml) and active template (url-add.yaml)
5. **Premature claims in CHANGELOGs** — "konsolidacja z 3 do 2" stated before verification

## Key Insights

1. **Code review is the critical quality gate** — caught real issues (security, fabricated data, incorrect counts) in EVERY story. Must be mandatory, not optional.
2. **Documentation drift is systemic** — root cause is duplication across 7+ files. Epic 16 addresses this with single source of truth and automated drift detection.
3. **Quality improves iteratively** — each sprint brings improvements; the team learns and adapts.
4. **Agent requires human verification** — especially dates, infrastructure state claims, security patterns. Agent is fast but makes subtle errors.

## Previous Retrospective Follow-Through

No retrospective was conducted for Epic 13 or Epic 14 (both marked `optional`). The most recent retrospective was Epic 12 (2026-02-18). This represents a gap of 3 epics without formal review.

**Observation:** Retrospectives for smaller epics were skipped, losing continuity in tracking action items and lessons learned.

## Next Epic Preview

### Epic 16: Documentation Consolidation & Verification (backlog)

**Stories:**
- 16-1: Create Single-Source Infrastructure Metrics File
- 16-2: Create Automated Documentation Drift Verification Script

**Dependencies on Epic 15:**
- Must reflect post-consolidation state
- API Gateway count: 3 (not 2 as PRD states) — PRD correction needed
- Endpoint counts: api-gw-app 11, api-gw-infra needs verification (7 vs 8)
- Template count changed after api-gw-url-add.yaml removal

**Key concern:** PRD and Epic 16 stories contain incorrect API Gateway count assumptions that must be corrected before implementation.

## Action Items

### Process Improvements

| # | Action | Owner | Deadline | Success Criteria |
|---|--------|-------|----------|-----------------|
| 1 | Code review mandatory for every story | Bob (SM) | From Epic 16 | Every story passes code review before done; recorded in workflow |
| 2 | Add security patterns to code review checklist | Quinn (QA) | Before Epic 16 | Checklist includes: no console.log of secrets, no hardcoded credentials, no API keys in client logs |
| 3 | CHANGELOG entries must use verified dates and facts | Amelia (Dev) | From Epic 16 | Agent guidelines include: never fabricate dates, verify claims before stating |

### Technical Debt

| # | Item | Owner | Priority |
|---|------|-------|----------|
| 1 | B-3: Rename legacy Lambda functions (lenie_2_db, lenie_2_internet) | Winston (design), Amelia (impl) | Medium |

### Documentation

| # | Action | Owner | Deadline | Success Criteria |
|---|--------|-------|----------|-----------------|
| 1 | Fix PRD — API Gateway count and endpoint counts | Alice (PO) | Before Epic 16 start | PRD reflects actual state: 3 API Gateways (app 11, infra 7, url-add 1) |
| 2 | Update Epic 16 story definitions with correct input data | Bob (SM) | Before Epic 16 start | Stories 16-1 and 16-2 have correct expected counts |

### Team Agreements

- Code review is **mandatory**, not optional — applies to every story
- Agent output requires **human verification** — especially dates, counts, infrastructure state claims
- Documentation updates are part of **definition of done** for every story

## Preparation Tasks for Epic 16

### Critical (must complete before epic starts)

- [ ] Fix PRD — actual API Gateway count and endpoint counts (Owner: Alice/PO)
- [ ] Verify actual endpoint count in api-gw-infra.yaml: 7 or 8? (Owner: Winston/Architect)
- [ ] Update Epic 16 story definitions with correct data (Owner: Bob/SM)

### Nice-to-Have

- [ ] Add security checklist to code review template (Owner: Quinn/QA)

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| Testing & Quality | OK | /url_add tested live, works |
| Deployment | OK | All changes deployed to AWS, CF stack deleted |
| Stakeholder Acceptance | OK | Chrome extension and React app work with new endpoint |
| Technical Health | OK | Codebase stable and maintainable |
| Unresolved Blockers | None | — |

**Overall:** Epic 15 is fully complete with zero open items. Ready to proceed to Epic 16 after preparation tasks are done.

## Significant Discoveries

**API Gateway Count Correction:**
- PRD states "API Gateways reduced from 3 to 2"
- Actual state: 3 API Gateways remain (app, infra, url-add)
- The removed template `api-gw-url-add.yaml` is different from `url-add.yaml` which retains its own API Gateway
- **Impact:** PRD must be corrected before Epic 16, which creates the documentation single source of truth
- **Severity:** Medium — does not change Epic 16's direction, but affects data accuracy

## Next Steps

1. Fix PRD — API Gateway count and endpoint counts
2. Verify api-gw-infra.yaml endpoint count (7 vs 8)
3. Update Epic 16 story definitions with correct data
4. Begin Epic 16 when preparation complete
