# Epic 7 Retrospective — Step Function Update & API Gateway Simplification

**Date:** 2026-02-16
**Facilitator:** Bob (Scrum Master)
**Participants:** Ziutus (Project Lead), Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev)
**Agent Model:** Claude Opus 4.6

## Epic Summary

| Story | Title | Status |
|-------|-------|--------|
| 7-1 | Update Step Function Schedule to Warsaw Time | Done |
| 7-2 | Remove `/url_add2` Endpoint from API Gateway & Redeploy | Done |

**Total:** 1 epic, 2 stories — 100% completion

## Delivery Metrics

- Stories completed: 2/2 (100%)
- Code review rounds: 3 (2 for 7-1, 1 for 7-2)
- Issues found in reviews: 17+ (mostly pre-existing, all addressed or tracked)
- Blockers encountered: 2 (ghost CF stack, missing SSM parameters)
- New technical debt items surfaced: 5 + 2 remaining action items
- Production incidents: 0
- cfn-lint results: 0 errors, 0 warnings on both modified templates

## What Went Well

### 1. Correct Course Workflow Saved a Critical Resource
Story 7-1 was originally planned to archive and delete the Step Function `sqs-to-rds`. The Correct Course workflow caught this mistake — the Step Function is a critical cost-optimization mechanism (auto start/stop RDS). The story was completely rewritten to update the schedule instead.

### 2. Code Review as Quality Driver
Both stories went through thorough code reviews that caught significant issues:
- Story 7-1 (2 rounds): stale `sqs_to_rds.json` file, IAM `Resource: "*"` wildcards, missing Tags, single-item `Or` wrapper
- Story 7-2 (1 round): clean approval, surfaced pre-existing issues (ApiDeployment pattern, stale deployments)

### 3. Git as Safety Net
Restoring Step Function files after the Correct Course was straightforward via `git checkout HEAD --`. Clean git history enabled painless recovery.

### 4. Template Size Bonus
Removing `/url_add2` from `api-gw-app.yaml` dropped the template to 51164 bytes — just under the 51200 byte inline limit. This eliminated the need for S3 packaging workflow, simplifying deployment to direct `aws cloudformation deploy --template-file`.

### 5. Cross-Story Learning
Story 7-2 included a "Previous Story (7-1) Learnings" section that documented ghost CF stacks, SSM parameter dependencies, and deploy.ini layer structure. Lessons from 7-1 were explicitly applied in 7-2.

## Challenges and Learnings

### 1. Incorrect Planning — Resource Deletion Without Verification
The original plan to delete the Step Function was based on confusion with a different function (possibly from another project). Root cause: no verification process for whether a resource is actively used before planning its removal. **Resolution:** Introduced "Resource Deletion Checklist" — before removing any AWS resource: (1) check code references, (2) check active state in AWS, (3) check dependency chain.

### 2. Pre-existing Technical Debt Surfacing
Both stories uncovered pre-existing issues during implementation:
- Story 7-1: ghost CF stack `lenie-dev-sqs-to-rds`, missing SSM parameters (`/lenie/dev/sqs/documents/url`, `/lenie/dev/database/name`)
- Story 7-2: ApiDeployment doesn't force redeployment on RestApi body changes, 36 stale API Gateway deployments, Lambda name typo `secrutity`

### 3. CloudFormation Deployment Gotchas
- Ghost stacks (resources manually deleted but stack record remains) must be explicitly deleted before creating new stacks
- API Gateway edge caching causes ~10 second propagation delay after deployment
- Manual `aws apigateway create-deployment` required due to ApiDeployment resource limitation

## Previous Retrospective Follow-Through

**Source:** Sprint 1 Retrospective (Epics 1-6, 2026-02-15)

| # | Commitment | Status | Evidence |
|---|-----------|--------|----------|
| 1 | Plan next sprint with new epics | ✅ Completed | Sprint 2 planned with PRD, architecture, and epics |
| 2 | Lambda Layer security audit (HIGH) | ❌ Not addressed | Deferred — tracked for Faza 2 |
| 3 | Future epics for Lambda CF, CORS hardening | ⏳ Partial | Sprint 3 backlog created with items from code reviews |

**Sprint 1 Lessons Applied in Epic 7:**
- ✅ "Live infrastructure differs from documentation" — discovered ghost stack and missing SSM params
- ✅ "Code review feedback loops" — 7-2 used learnings from 7-1
- ✅ "Codebase-wide search after deletions" — grep verified zero `url_add2` references

## Technical Debt

| # | Item | Source | Priority |
|---|------|--------|----------|
| 1 | Replace `{{resolve:ssm:...}}` with `AWS::SSM::Parameter::Value<String>` in sqs-to-rds-step-function.yaml | Story 7-1 | Medium |
| 2 | Parameterize hardcoded Lambda name `lenie-sqs-to-db` in DefinitionString | Story 7-1 | Medium |
| 3 | Fix ApiDeployment pattern — force redeployment on RestApi body changes | Story 7-2 | Medium |
| 4 | Remove 36 stale API Gateway deployments | Story 7-2 | Low |
| 5 | Fix Lambda name typo `secrutity` → `security` | Sprint 1 / 7-2 | Medium |
| 6 | GET method on `/website_delete` — should be DELETE | Story 7-2 | Medium |
| 7 | Lambda Layer dependencies ~1.5 years old — security audit and rebuild | Sprint 1 retro | High |
| 8 | CORS wildcard `Access-Control-Allow-Origin: '*'` | Sprint 1 retro | Medium |

## Strategic Priority (Agreed with Ziutus)

**Three-phase approach before MCP Server implementation:**

1. **Phase 1: Remove unnecessary things** — cleanup remaining unused AWS resources, dead code, stale references, orphaned resources
2. **Phase 2: Tech Debt Cleanup** — address all 8 items above, Lambda Layer security audit, Sprint 3 backlog items
3. **Phase 3: MCP Server Implementation** — build on clean, secure codebase

## Process Improvements

1. **Resource Deletion Checklist** — for every AWS resource planned for removal: (1) check code references, (2) check active state in AWS, (3) check dependency chain. Added to story template for cleanup stories.
2. **Continue code review on every story** — proven effective with 17+ issues caught in Epic 7.

## Key Takeaways

1. **Always verify usage before deleting a resource** — Resource Deletion Checklist prevents removing active resources
2. **Code review pays off** — 17+ issues detected, including security improvements (IAM wildcards, stale files)
3. **Correct Course workflow works** — saved critical Step Function from deletion
4. **Tech debt requires dedicated time** — postponing only makes it worse; committed to Phase 2 cleanup

## Readiness Assessment

- Testing & Quality: ✅ Both stories verified against live AWS
- Deployment: ✅ Both stacks updated in us-east-1
- Stakeholder Acceptance: ✅ Confirmed by Ziutus
- Technical Health: ✅ Stable, zero production incidents
- Unresolved Blockers: ✅ None

## Next Steps

1. Execute Phase 1: Remove unnecessary things (orphaned resources, dead code)
2. Execute Phase 2: Tech debt cleanup (8 items, including Lambda Layer security audit)
3. Execute Phase 3: MCP Server implementation on clean codebase
4. Review action items in next standup — ensure ownership and tracking
