# Epic 8 Retrospective — DynamoDB Cache Table Removal

**Date:** 2026-02-16
**Facilitator:** Bob (Scrum Master)
**Participants:** Ziutus (Project Lead), Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev)
**Agent Model:** Claude Opus 4.6
**Sprint:** 2 — Cleanup & Vision Documentation

## Epic Summary

| Story | Title | Status |
|-------|-------|--------|
| 8-1 | Delete DynamoDB Cache Tables & Remove All Related Artifacts | Done |

**Total:** 1 story, 27 subtasks — 100% completion

## Delivery Metrics

- Stories completed: 1/1 (100%)
- Subtasks completed: 27/27 (100%)
- Code review rounds: 2 (1 review + 1 re-review)
- Issues found in reviews: 5 (2 MEDIUM + 3 LOW) — all documentation-related
- Blockers encountered: 0
- All AWS operations: success on first attempt
- Technical debt items surfaced: 1 new (+ 8 carried from Epic 7)
- Production incidents: 0
- Grep verification: 7 patterns, zero stale references outside `_bmad-output/`

## What Went Well

### 1. Sprint 1 Investment Paid Off
The DynamoDB cache templates were created via CF import in Sprint 1 specifically to enable clean, CF-managed deletion in Sprint 2. This forward planning resulted in a flawless execution — 3 `delete-stack` commands and done.

### 2. Resource Deletion Checklist — Fully Applied
The checklist introduced after Epic 7 was applied perfectly in Story 8-1:
- Code references checked (zero backend references confirmed)
- Active state in AWS verified
- Dependency chain analyzed (no SSM parameter consumers)
- `lenie_dev_documents` explicitly protected and verified ACTIVE after operations

### 3. Clean AWS Execution
All AWS operations succeeded on first attempt — zero errors, zero debugging. The two-step DeletionPolicy: Retain process (CF stack deletion → manual table deletion) worked flawlessly.

### 4. Cross-Story Learning
Story 8-1 included a "Previous Story Intelligence" section explicitly documenting lessons from Stories 7-1 (ghost stacks) and 7-2 (verification pattern). These lessons were proactively applied.

### 5. 100% Follow-Through on Epic 7 Action Items
Both action items from Epic 7 retrospective were completed:
- Resource Deletion Checklist: Applied and effective
- Code review on every story: 2 rounds, 5 issues caught

## Challenges and Learnings

### 1. Documentation Is Consistently the Weakest Area
All 5 review issues were documentation-related, not infrastructure:
- [MEDIUM] README.md section 15.9 total count wrong (~29 → ~26)
- [MEDIUM] deploy.ini rds.yaml comment changed out of scope
- [LOW] 6 BMAD "Story X.Y" references in README.md and CLAUDE.md
- [LOW] "Document metadata cache" → "Document metadata buffer" terminology
- [LOW] Dev Agent Record lacks CLI verification output evidence

This pattern was also observed in Epic 7 (17+ issues, many doc-related) and Epic 9 (10 issues, all doc-related).

### 2. Grep Verification: Necessary but Not Sufficient
Seven grep patterns confirmed zero stale references in Epic 8. However, Epic 9's code review later revealed that grep misses semantic issues: stale numeric counts, package name changes, terminology inconsistencies. Automated search must be complemented by semantic review.

### 3. Out-of-Scope Discovery
CLAUDE.md states "13 endpoints" for api-gw-app.yaml — actual count is 21. Not caused by Epic 8, but discovered during review.

## Previous Retrospective Follow-Through

**Source:** Epic 7 Retrospective (2026-02-16)

| # | Action Item | Status | Evidence in Epic 8 |
|---|------------|--------|-------------------|
| 1 | Resource Deletion Checklist | ✅ Completed | Cache tables confirmed unused, lenie_dev_documents protected, zero accidental deletions |
| 2 | Code review on every story | ✅ Completed | 2 review rounds, 5 issues caught and fixed |

**Follow-through rate: 2/2 (100%)** — best result across all retrospectives.

**Epic 7 Lessons Applied:**

| Lesson | Applied? | Evidence |
|--------|----------|---------|
| Always verify usage before deleting | ✅ Yes | 7 grep patterns, lenie_dev_documents explicitly protected |
| Code review pays off | ✅ Yes | 5 documentation issues caught |
| Correct Course workflow works | N/A | No course correction needed in Epic 8 |
| Tech debt requires dedicated time | ⏳ In progress | Epic 8 = Phase 1 (removal). Phase 2 (tech debt) pending |

## Dependency Analysis Deep Dive

During the retrospective, Ziutus requested a full dependency chain analysis before removing endpoints. Key finding:

### `ai_ask()` Function — CRITICAL DEPENDENCY
- **Production usage:** Only `youtube_processing.py:290` (AI summary generation)
- **Decision:** Remove the `/ai_ask` endpoint but KEEP the `ai_ask()` function — it's actively used
- **Future:** When MCP Server is built, Claude Desktop may take over AI summary generation, making `ai_ask()` removable

### `ai_describe_image()` Function — DEAD CODE
- Defined in `library/ai.py:97` but never called anywhere
- **Decision:** Remove as dead code in Sprint 3

### `ai_summary_needed` Ecosystem
- Database column with index, used across 8+ files
- Full flow: URL added → flag set → youtube_processing generates summary via `ai_ask()`
- **Decision:** Keep for now. Analyze removal when MCP Server takes over AI capabilities (Phase 3)

## Technical Debt

| # | Item | Source | Priority | Notes |
|---|------|--------|----------|-------|
| 1 | CLAUDE.md endpoint count "13" vs actual 21 | Epic 8 review | Low | Quick fix |
| 2 | `ai_describe_image()` dead code | Epic 8 analysis | Low | Never called |
| 3 | Replace `{{resolve:ssm:...}}` with `AWS::SSM::Parameter::Value<String>` | Epic 7 | Medium | Phase 2 |
| 4 | Parameterize hardcoded Lambda name `lenie-sqs-to-db` | Epic 7 | Medium | Phase 2 |
| 5 | Fix ApiDeployment pattern — force redeployment | Epic 7 | Medium | Phase 2 |
| 6 | Remove 36 stale API Gateway deployments | Epic 7 | Low | Phase 2 |
| 7 | Fix Lambda name typo `secrutity` → `security` | Epic 7 | Medium | Phase 2 |
| 8 | GET method on `/website_delete` — should be DELETE | Epic 7 | Medium | Phase 2 |
| 9 | Lambda Layer dependencies ~1.5+ years old — security audit | Sprint 1 | High | Phase 2 |
| 10 | CORS wildcard `Access-Control-Allow-Origin: '*'` | Sprint 1 | Medium | Phase 2 |

## Action Items

### Process Improvements

| # | Action | Owner | Deadline | Success Criteria |
|---|--------|-------|----------|-----------------|
| 1 | Expand verification checklist with semantic review patterns | Dana (QA) | Before Sprint 3 | Checklist covers: grep patterns + numeric counts + package names + terminology |
| 2 | Require CLI verification evidence in Dev Agent Record | Bob (SM) | Before Sprint 3 | Story template includes "CLI verification evidence" section |

### Sprint 3 Preparation — Endpoint Cleanup

| # | Endpoint | Action | Scope |
|---|----------|--------|-------|
| 1 | `/ai_ask` | Remove endpoint, KEEP `ai_ask()` function | server.py, Lambda, API GW, Frontend |
| 2 | `/translate` | Remove endpoint (already broken — backend module missing) | Lambda, API GW, Frontend |
| 3 | `/infra/ip-allow` | Remove endpoint | Lambda in AWS, API GW |
| 4 | `ai_describe_image()` | Remove dead code | library/ai.py |

### Sprint 3 Preparation — Tactical Backlog

| # | Item | Priority |
|---|------|----------|
| 1 | AWS resource tagging (Project, Environment) for Cost Explorer | Medium |
| 2 | Parameterize Lambda name in Step Function | Medium |
| 3 | `{{resolve:ssm:...}}` → `AWS::SSM::Parameter::Value<String>` | Medium |
| 4 | Fix ApiDeployment pattern | Medium |
| 5 | Fix Lambda name typo `secrutity` → `security` | Medium |
| 6 | Review `/website_delete` GET method | Medium |

### Strategic Topics for Future Discussion (Phase 3)

1. **DB abstraction layer** — separate raw psycopg2 from business logic before MCP Server
2. **AI summary migration** — Claude Desktop takes over `ai_ask()` role; analyze removal of `ai_summary_needed` ecosystem
3. **`test_code/` cleanup** — review and clean experimental scripts

## Priority Principle (Confirmed by Ziutus)

**Clean first → Secure second → Build new third**

1. **Phase 1 (current):** Remove unnecessary functionality, dead code, unused endpoints
2. **Phase 2:** Security updates — Lambda Layer audit, CORS fix, etc. (only on code that survives cleanup)
3. **Phase 3:** MCP Server Foundation — DB abstraction, AI migration, new capabilities

## Team Agreements

- Resource Deletion Checklist applied on every cleanup story
- Documentation stories receive same review rigor as code stories
- Cross-story learning via "Previous Story Intelligence" section
- Grep verification expanded with semantic review
- Priority principle: clean → secure → build new

## Key Takeaways

1. **Forward planning pays off** — Sprint 1 CF import investment enabled flawless Sprint 2 deletion
2. **Resource Deletion Checklist works** — 100% follow-through, zero accidental deletions
3. **Documentation is consistently the weakest area** — 5/5 Epic 8 issues, 10/10 Epic 9 issues were doc-related
4. **Dependency analysis before removal is critical** — `ai_ask()` would have been incorrectly removed without checking `youtube_processing.py`

## Readiness Assessment

- Testing & Quality: ✅ AWS CLI verified, 7 grep patterns clean, lenie_dev_documents ACTIVE
- Deployment: ✅ 3 CF stacks deleted, 3 DynamoDB tables deleted, 6 SSM params removed
- Stakeholder Acceptance: ✅ Confirmed by Ziutus (2 review rounds)
- Technical Health: ✅ Stable, zero production incidents
- Unresolved Blockers: ✅ None

## Next Steps

1. **Sprint 3 Planning** — Phase 1 cleanup continuation: remove 3 endpoints + tactical backlog
2. **Execute process improvements** — semantic review checklist, CLI evidence template
3. **Phase 2 (after cleanup)** — address security debt (Lambda Layers, CORS, etc.)
4. **Phase 3 (after security)** — MCP Server: DB abstraction, AI summary migration
